<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>单词发音练习</title>
  <!-- 引入外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="default-lists.js"></script>
  
  <!-- PWA配置 -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3B82F6">
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#EF4444',
            dark: '#1E293B',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.1), 0 8px 10px -6px rgba(59, 130, 246, 0.1);
      }
      .btn-hover {
        @apply transition-all duration-300 hover:scale-105 active:scale-95;
      }
      .loop-active {
        animation: pulse 2s infinite;
      }
      .modal-backdrop {
        backdrop-filter: blur(4px);
      }
      .save-indicator {
        animation: fadeInOut 2s;
      }
      .list-item-active {
        @apply bg-primary/10 border-primary font-medium;
      }
      .play-time-btn.active {
        @apply bg-primary text-white border-primary;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
      }
      @keyframes fadeInOut {
        0% { opacity: 0; }
        50% { opacity: 1; }
        100% { opacity: 0; }
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4 font-sans">
  <div class="w-full max-w-md bg-white rounded-2xl p-8 card-shadow">
    <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-center text-dark mb-8">单词发音练习</h1>
    
    <!-- 列表和播放次数设置区 -->
    <div class="mb-6 flex flex-col gap-2">
      <div class="flex justify-between items-center">
        <div class="text-sm text-gray-500">当前列表: <span id="current-list-name" class="font-medium text-primary">默认列表</span></div>
        <div class="flex gap-2">
          <button id="word-list-btn" class="text-sm text-primary hover:text-primary/80 flex items-center gap-1">
            <i class="fa fa-list-ul"></i>
            <span>单词列表</span>
          </button>
          <button id="list-manager-btn" class="text-sm text-primary hover:text-primary/80 flex items-center gap-1">
            <i class="fa fa-list"></i>
            <span>列表管理</span>
          </button>
        </div>
      </div>
      <div class="text-sm text-gray-500">
        默认播放次数: <span id="default-times-display" class="font-medium text-primary">3次</span>
        <button id="change-default-times" class="ml-1 text-xs text-primary hover:underline">修改</button>
      </div>
    </div>
    
    <!-- 单词显示区 -->
    <div class="mb-10 text-center">
      <div class="text-gray-500 mb-2 text-lg">当前单词</div>
      <div id="word-display" class="text-[clamp(2rem,5vw,3rem)] font-bold text-primary transition-all duration-500 transform">apple</div>
      <div id="phonetic-display" class="mt-2 text-[clamp(1rem,2vw,1.2rem)] text-gray-500">/ˈæpl/</div>
      <div id="meaning-display" class="mt-3 text-[clamp(1.2rem,3vw,1.5rem)] text-gray-600 italic">苹果</div>
    </div>
    
    <!-- 控制按钮区 -->
    <div class="flex flex-col gap-4">
      <button id="play-btn" class="bg-primary hover:bg-primary/90 text-white py-4 px-6 rounded-xl flex items-center justify-center gap-2 btn-hover">
        <i class="fa fa-volume-up text-xl"></i>
        <span>播放发音</span>
      </button>
      
      <button id="play-default-btn" class="bg-orange-500 hover:bg-orange-600 text-white py-3 px-6 rounded-xl flex items-center justify-center gap-2 btn-hover">
        <i class="fa fa-repeat text-xl"></i>
        <span>按默认次数播放</span>
      </button>
      
      <button id="pause-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white py-3 px-6 rounded-xl flex items-center justify-center gap-2 btn-hover hidden">
        <i class="fa fa-pause text-xl"></i>
        <span>暂停播放</span>
      </button>
      
      <button id="import-btn" class="bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 rounded-xl flex items-center justify-center gap-2 btn-hover">
        <i class="fa fa-upload text-xl"></i>
        <span>导入单词到当前列表</span>
      </button>

      <button id="reset-btn" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-6 rounded-xl flex items-center justify-center gap-2 btn-hover text-sm">
        <i class="fa fa-refresh"></i>
        <span>清空当前列表</span>
      </button>
      
      <button id="show-word-list-btn" class="bg-teal-600 hover:bg-teal-700 text-white py-3 px-6 rounded-xl flex items-center justify-center gap-2 btn-hover">
        <i class="fa fa-list-ul text-xl"></i>
        <span>显示单词列表</span>
      </button>
      
      <button id="prev-btn" class="bg-blue-700 hover:bg-blue-800 text-white py-4 px-6 rounded-xl flex items-center justify-center gap-2 btn-hover">
        <i class="fa fa-arrow-left text-xl"></i>
        <span>上一个单词</span>
      </button>
      
      <button id="next-btn" class="bg-secondary hover:bg-secondary/90 text-white py-4 px-6 rounded-xl flex items-center justify-center gap-2 btn-hover">
        <i class="fa fa-arrow-right text-xl"></i>
        <span>下一个单词</span>
      </button>
    </div>
    
    <!-- 状态区 -->
    <div class="mt-8 text-center text-gray-500">
      <div id="status" class="mb-2 text-sm">状态：单次播放模式</div>
      <div id="progress">1/10</div>
      <div id="save-hint" class="mt-1 text-xs text-green-500 hidden save-indicator">操作已保存</div>
    </div>
  </div>
  
  <!-- 导入弹窗 -->
  <div id="import-modal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
    <div class="w-full max-w-md bg-white rounded-2xl p-6 card-shadow transform transition-all">
      <h2 class="text-xl font-bold text-dark mb-4">导入单词到当前列表</h2>
      <p class="text-gray-500 text-sm mb-4">请输入单词，每行一个（格式：英文 音标 中文 或 英文:音标:中文）</p>
      <textarea 
        id="word-input" 
        class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all resize-none"
        placeholder="例如：
apple /ˈæpl/ 苹果
banana:/bəˈnɑːnə/:香蕉
computer /kəmˈpjuːtə/ 电脑
..."
      ></textarea>
      <div class="mt-4 flex gap-3">
        <button id="cancel-import" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-xl btn-hover">取消</button>
        <button id="confirm-import" class="flex-1 bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-xl btn-hover">确认导入</button>
      </div>
    </div>
  </div>

  <!-- 列表管理弹窗 -->
  <div id="list-manager-modal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
    <div class="w-full max-w-md bg-white rounded-2xl p-6 card-shadow transform transition-all">
      <h2 class="text-xl font-bold text-dark mb-4">单词列表管理</h2>
      <div class="flex gap-2 mb-4">
        <input 
          type="text" 
          id="new-list-name" 
          placeholder="输入新列表名称" 
          class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
        >
        <button id="create-list-btn" class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg btn-hover">
          <i class="fa fa-plus"></i>
        </button>
      </div>
      <div id="lists-container" class="max-h-60 overflow-y-auto mb-4"></div>
      <div class="flex gap-3">
        <button id="close-list-manager" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-xl btn-hover">关闭</button>
        <button id="delete-list-btn" class="flex-1 bg-accent hover:bg-accent/90 text-white py-3 px-4 rounded-xl btn-hover">
          <i class="fa fa-trash"></i>
          <span>删除选中列表</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 播放次数设置弹窗 -->
  <div id="play-times-modal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
    <div class="w-full max-w-md bg-white rounded-2xl p-6 card-shadow transform transition-all">
      <h2 class="text-xl font-bold text-dark mb-4" id="play-times-modal-title">设置播放次数</h2>
      <p class="text-gray-500 text-sm mb-4">选择单词的播放次数（1-100次），播放完成后自动下一个</p>
      <div class="grid grid-cols-5 gap-2 mb-6">
        <button class="play-time-btn py-3 border rounded-lg hover:bg-primary/10 transition-all" data-times="1">1次</button>
        <button class="play-time-btn py-3 border rounded rounded-lg hover:bg-primary/10 transition-all" data-times="2">2次</button>
        <button class="play-time-btn py-3 border rounded-lg hover:bg-primary/10 transition-all" data-times="3">3次</button>
        <button class="play-time-btn py-3 border rounded-lg hover:bg-primary/10 transition-all" data-times="5">5次</button>
        <button class="play-time-btn py-3 border rounded-lg hover:bg-primary/10 transition-all" data-times="10">10次</button>
      </div>
      <div class="flex gap-2 mb-4">
        <input 
          type="number" 
          id="custom-times" 
          min="1" 
          max="100" 
          placeholder="1-100之间的次数" 
          class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
        >
        <button id="confirm-custom-times" class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg btn-hover">确认</button>
      </div>
      <div class="flex gap-3">
        <button id="cancel-play-times" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-xl btn-hover">取消</button>
        <button id="stop-play-btn" class="flex-1 bg-accent hover:bg-accent/90 text-white py-3 px-4 rounded-xl btn-hover hidden">
          <i class="fa fa-stop"></i>
          <span>停止播放</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- 单词列表弹窗 -->
  <div id="word-list-modal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center p-4 z-50 hidden">
    <div class="w-full max-w-md bg-white rounded-2xl p-6 card-shadow transform transition-all">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-dark">当前列表单词</h2>
        <button id="close-word-list" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fa fa-times text-xl"></i>
        </button>
      </div>
      <p class="text-gray-500 text-sm mb-4">点击单词可直接跳转到该单词</p>
      <div id="word-list-container" class="max-h-[70vh] overflow-y-auto mb-4">
        <!-- 单词列表将通过JavaScript动态生成 -->
      </div>
      <div class="flex gap-3">
        <button id="cancel-word-list" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 px-4 rounded-xl btn-hover">关闭</button>
        <button id="shuffle-words-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-xl btn-hover">
          <i class="fa fa-random"></i>
          <span>随机排序</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // 后台播放支持 - 唤醒锁相关
    let wakeLock = null;
    let audioContext = null;
    
    // 申请唤醒锁
    async function requestWakeLock() {
      if ('wakeLock' in navigator && !wakeLock) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('唤醒锁申请成功');
          
          // 监听唤醒锁释放事件，自动重新申请
          wakeLock.addEventListener('release', () => {
            if (isPlayingByTimes) {
              setTimeout(requestWakeLock, 1000);
            }
          });
        } catch (err) {
          console.log('唤醒锁申请失败：', err);
        }
      }
    }
    
    // 释放唤醒锁
    function releaseWakeLock() {
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
        console.log('唤醒锁已释放');
      }
    }
    
    // 激活音频上下文
    function activateAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
    }
    
    // 初始化数据
    function initVocabularyData() {
      const saved = localStorage.getItem('vocabularyData');
      if (saved) {
        const savedData = JSON.parse(saved);
        
        // 检查是否有默认列表，如果没有则添加
        if (!savedData.lists["默认列表"]) {
          savedData.lists["默认列表"] = DEFAULT_LISTS["默认列表"];
        }
        
        return savedData;
      }
      
      // 如果没有保存的数据，返回包含默认列表的数据
      return {
        lists: DEFAULT_LISTS,
        currentList: "默认列表",
        defaultPlayTimes: 3
      };
    }
    
    // 保存数据到本地存储
    function saveVocabularyData() {
      localStorage.setItem('vocabularyData', JSON.stringify(vocabularyData));
      showSaveHint();
    }
    
    // 显示保存提示
    function showSaveHint() {
      const hint = document.getElementById('save-hint');
      hint.classList.remove('hidden');
      setTimeout(() => hint.classList.add('hidden'), 2000);
    }
    
    // 全局变量
    let vocabularyData = initVocabularyData();
    let vocabularyList = vocabularyData.lists[vocabularyData.currentList];
    let currentIndex = localStorage.getItem('currentWordIndex') ? Math.min(parseInt(localStorage.getItem('currentWordIndex')), vocabularyList.length - 1) : 0;
    let currentPlayTimes = 0;
    let targetPlayTimes = 0;
    let isPlayingByTimes = false;
    let isPaused = false;
    let playTimeout = null;
    let currentUtterance = null;
    
    // DOM元素
    const wordDisplay = document.getElementById('word-display');
    const phoneticDisplay = document.getElementById('phonetic-display');
    const meaningDisplay = document.getElementById('meaning-display');
    const playBtn = document.getElementById('play-btn');
    const playDefaultBtn = document.getElementById('play-default-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const importBtn = document.getElementById('import-btn');
    const resetBtn = document.getElementById('reset-btn');
    const progressIndicator = document.getElementById('progress');
    const statusIndicator = document.getElementById('status');
    const currentListNameEl = document.getElementById('current-list-name');
    const listManagerBtn = document.getElementById('list-manager-btn');
    const wordListBtn = document.getElementById('word-list-btn');
    const showWordListBtn = document.getElementById('show-word-list-btn');
    const defaultTimesDisplay = document.getElementById('default-times-display');
    const changeDefaultTimesBtn = document.getElementById('change-default-times');
    const playTimesModalTitle = document.getElementById('play-times-modal-title');
    
    // 模态框元素
    const importModal = document.getElementById('import-modal');
    const wordInput = document.getElementById('word-input');
    const cancelImport = document.getElementById('cancel-import');
    const confirmImport = document.getElementById('confirm-import');
    const listManagerModal = document.getElementById('list-manager-modal');
    const listsContainer = document.getElementById('lists-container');
    const newListNameInput = document.getElementById('new-list-name');
    const createListBtn = document.getElementById('create-list-btn');
    const closeListManagerBtn = document.getElementById('close-list-manager');
    const deleteListBtn = document.getElementById('delete-list-btn');
    const playTimesModal = document.getElementById('play-times-modal');
    const customTimesInput = document.getElementById('custom-times');
    const confirmCustomTimesBtn = document.getElementById('confirm-custom-times');
    const cancelPlayTimesBtn = document.getElementById('cancel-play-times');
    const stopPlayBtn = document.getElementById('stop-play-btn');
    const wordListModal = document.getElementById('word-list-modal');
    const wordListContainer = document.getElementById('word-list-container');
    const closeWordListBtn = document.getElementById('close-word-list');
    const cancelWordListBtn = document.getElementById('cancel-word-list');
    const shuffleWordsBtn = document.getElementById('shuffle-words-btn');
    
    // 播放单词发音
    function speakWord(word, onEnd = null) {
      window.speechSynthesis.cancel();
      currentUtterance = new SpeechSynthesisUtterance(word);
      currentUtterance.lang = 'en-US';
      currentUtterance.rate = 0.8;
      currentUtterance.pitch = 1.1;
      if (onEnd) currentUtterance.onend = onEnd;
      window.speechSynthesis.speak(currentUtterance);
      
      // 动画效果
      wordDisplay.classList.add('scale-110', 'text-secondary');
      setTimeout(() => wordDisplay.classList.remove('scale-110', 'text-secondary'), 500);
    }
    
    // 按次数播放
    function playWordByTimes(times, isDefault = false) {
      if (vocabularyList.length === 0) return;
      const validTimes = Math.min(Math.max(times, 1), 100);
      
      if (isDefault) {
        vocabularyData.defaultPlayTimes = validTimes;
        saveVocabularyData();
        defaultTimesDisplay.textContent = `${validTimes}次`;
      }
      
      targetPlayTimes = validTimes;
      currentPlayTimes = 0;
      isPlayingByTimes = true;
      isPaused = false;
      
      // 申请唤醒锁（关键）
      requestWakeLock();
      
      playTimesModal.classList.add('hidden');
      stopPlayBtn.classList.remove('hidden');
      pauseBtn.classList.remove('hidden');
      pauseBtn.innerHTML = '<i class="fa fa-pause text-xl"></i><span>暂停播放</span>';
      statusIndicator.textContent = `状态：正在播放（${currentPlayTimes}/${targetPlayTimes}次）`;
      
      playNextTime();
    }
    
    // 播放下一次
    function playNextTime() {
      if (!isPlayingByTimes || isPaused) return;
      
      currentPlayTimes++;
      statusIndicator.textContent = `状态：正在播放（${currentPlayTimes}/${targetPlayTimes}次）`;
      
      const currentWord = vocabularyList[currentIndex].english;
      speakWord(currentWord, () => {
        if (!isPlayingByTimes || isPaused) return;
        
        if (currentPlayTimes >= targetPlayTimes) {
          resetPlayTimesState();
          nextWordWithPlay();
        } else {
          playTimeout = setTimeout(playNextTime, 500);
        }
      });
    }
    
    // 下一个单词并播放
    function nextWordWithPlay() {
      if (vocabularyList.length === 0) return;
      
      window.speechSynthesis.cancel();
      clearTimeout(playTimeout);
      
      currentIndex = (currentIndex + 1) % vocabularyList.length;
      localStorage.setItem('currentWordIndex', currentIndex);
      displayCurrentWord();
      playWordByTimes(vocabularyData.defaultPlayTimes);
    }
    
    // 重置播放状态
    function resetPlayTimesState() {
      currentPlayTimes = 0;
      targetPlayTimes = 0;
      isPlayingByTimes = false;
      isPaused = false;
      clearTimeout(playTimeout);
      stopPlayBtn.classList.add('hidden');
      pauseBtn.classList.add('hidden');
      statusIndicator.textContent = '状态：单次播放模式';
      // 释放唤醒锁
      releaseWakeLock();
    }
    
    // 暂停/继续
    function togglePause() {
      if (!isPlayingByTimes) return;
      
      if (isPaused) {
        isPaused = false;
        pauseBtn.innerHTML = '<i class="fa fa-pause text-xl"></i><span>暂停播放</span>';
        statusIndicator.textContent = `状态：正在播放（${currentPlayTimes}/${targetPlayTimes}次）`;
        // 继续播放时重新申请唤醒锁
        requestWakeLock();
        if (currentPlayTimes < targetPlayTimes) {
          playTimeout = setTimeout(playNextTime, 500);
        }
      } else {
        isPaused = true;
        window.speechSynthesis.pause();
        clearTimeout(playTimeout);
        pauseBtn.innerHTML = '<i class="fa fa-play text-xl"></i><span>继续播放</span>';
        statusIndicator.textContent = `状态：已暂停（${currentPlayTimes}/${targetPlayTimes}次）`;
        // 暂停时释放唤醒锁
        releaseWakeLock();
      }
    }
    
    // 停止播放
    function stopPlayByTimes() {
      window.speechSynthesis.cancel();
      resetPlayTimesState();
      playTimesModal.classList.add('hidden');
      releaseWakeLock();
    }
    
    // 显示当前单词
    function displayCurrentWord() {
      if (vocabularyList.length === 0) {
        wordDisplay.textContent = "无单词";
        phoneticDisplay.textContent = "";
        meaningDisplay.textContent = "请导入单词到当前列表";
        progressIndicator.textContent = "0/0";
        return;
      }
      
      wordDisplay.textContent = vocabularyList[currentIndex].english;
      phoneticDisplay.textContent = vocabularyList[currentIndex].phonetic;
      meaningDisplay.textContent = vocabularyList[currentIndex].chinese;
      progressIndicator.textContent = `${currentIndex + 1}/${vocabularyList.length}`;
    }
    
    // 上一个单词
    function prevWord() {
      if (vocabularyList.length === 0) return;
      
      window.speechSynthesis.cancel();
      resetPlayTimesState();
      
      currentIndex = (currentIndex - 1 + vocabularyList.length) % vocabularyList.length;
      localStorage.setItem('currentWordIndex', currentIndex);
      displayCurrentWord();
    }
    
    // 下一个单词
    function nextWord() {
      if (vocabularyList.length === 0) return;
      
      window.speechSynthesis.cancel();
      resetPlayTimesState();
      
      currentIndex = (currentIndex + 1) % vocabularyList.length;
      localStorage.setItem('currentWordIndex', currentIndex);
      displayCurrentWord();
    }
    
    // 打开导入弹窗
    function openImportModal() {
      wordInput.value = vocabularyList.map(item => `${item.english}:${item.phonetic}:${item.chinese}`).join('\n');
      importModal.classList.remove('hidden');
      setTimeout(() => wordInput.focus(), 100);
    }
    
    // 关闭导入弹窗
    function closeImportModal() {
      importModal.classList.add('hidden');
    }
    
    // 确认导入
    function confirmWordImport() {
      const inputText = wordInput.value.trim();
      if (!inputText) {
        alert('请输入至少一个单词');
        return;
      }
      
      const newWords = inputText.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .map(line => {
          const separator = line.includes(':') ? ':' : ' ';
          const parts = line.split(separator).map(item => item.trim()).filter(part => part);
          
          let english = parts[0] || '';
          let phonetic = parts[1] || '无音标';
          let chinese = parts[2] || parts[1] || '无含义';
          
          if (parts.length === 2) {
            phonetic = '无音标';
            chinese = parts[1];
          }
          
          const hasChinese = /[\u4e00-\u9fa5]/.test(english);
          if (hasChinese) [chinese, phonetic, english] = [english, phonetic, chinese];
          
          return { english, phonetic, chinese };
        });
      
      if (newWords.length === 0) {
        alert('请输入有效的单词');
        return;
      }
      
      vocabularyList = newWords;
      vocabularyData.lists[vocabularyData.currentList] = newWords;
      saveVocabularyData();
      
      currentIndex = 0;
      localStorage.setItem('currentWordIndex', currentIndex);
      resetPlayTimesState();
      
      displayCurrentWord();
      closeImportModal();
      alert(`成功导入 ${newWords.length} 个单词`);
    }

    // 清空当前列表
    function clearCurrentList() {
      const currentListName = vocabularyData.currentList;
      
      // 重置为默认列表
      if (confirm(`确定要重置"${currentListName}"吗？将恢复为初始单词`)) {
        vocabularyList = [...DEFAULT_LISTS["默认列表"]];
        vocabularyData.lists[currentListName] = vocabularyList;
      } else return;
      
      saveVocabularyData();
      currentIndex = 0;
      localStorage.setItem('currentWordIndex', currentIndex);
      resetPlayTimesState();
      displayCurrentWord();
      showSaveHint();
    }
    
    // 渲染单词列表
    function renderWordList() {
      wordListContainer.innerHTML = '';
      
      if (vocabularyList.length === 0) {
        wordListContainer.innerHTML = '<div class="text-center text-gray-500 py-8">当前列表无单词</div>';
        return;
      }
      
      vocabularyList.forEach((word, index) => {
        const wordItem = document.createElement('div');
        wordItem.className = `p-3 border rounded-lg mb-2 cursor-pointer transition-all ${
          index === currentIndex ? 'list-item-active' : 'hover:bg-gray-50 border-gray-200'
        }`;
        wordItem.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <div class="font-medium ${index === currentIndex ? 'text-primary' : 'text-gray-800'}">${word.english}</div>
              <div class="text-xs text-gray-500">${word.phonetic} | ${word.chinese}</div>
            </div>
            <div class="flex gap-2">
              <button class="text-primary hover:text-primary/80 play-word-in-list" data-index="${index}">
                <i class="fa fa-volume-up"></i>
              </button>
              <span class="text-xs text-gray-400">${index + 1}</span>
            </div>
          </div>
        `;
        
        wordItem.addEventListener('click', (e) => {
          // 如果点击的是播放按钮，不跳转到单词
          if (!e.target.closest('.play-word-in-list')) {
            goToWord(index);
          }
        });
        
        // 绑定播放按钮事件
        const playBtn = wordItem.querySelector('.play-word-in-list');
        playBtn.addEventListener('click', () => {
          speakWord(word.english);
        });
        
        wordListContainer.appendChild(wordItem);
      });
    }
    
    // 跳转到指定单词
    function goToWord(index) {
      if (index < 0 || index >= vocabularyList.length) return;
      
      window.speechSynthesis.cancel();
      resetPlayTimesState();
      
      currentIndex = index;
      localStorage.setItem('currentWordIndex', currentIndex);
      displayCurrentWord();
      
      // 如果单词列表模态框是打开的，更新列表中当前单词的高亮状态
      if (!wordListModal.classList.contains('hidden')) {
        renderWordList();
      }
    }
    
    // 随机排序单词
    function shuffleWords() {
      if (vocabularyList.length <= 1) return;
      
      // Fisher-Yates 洗牌算法
      for (let i = vocabularyList.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [vocabularyList[i], vocabularyList[j]] = [vocabularyList[j], vocabularyList[i]];
      }
      
      vocabularyData.lists[vocabularyData.currentList] = vocabularyList;
      saveVocabularyData();
      
      // 保持当前单词不变
      const currentWord = vocabularyList[currentIndex];
      const newIndex = vocabularyList.findIndex(word => 
        word.english === currentWord.english && 
        word.phonetic === currentWord.phonetic && 
        word.chinese === currentWord.chinese
      );
      
      if (newIndex !== -1 && newIndex !== currentIndex) {
        currentIndex = newIndex;
        localStorage.setItem('currentWordIndex', currentIndex);
      }
      
      renderWordList();
      displayCurrentWord();
      showSaveHint();
    }
    
    // 打开单词列表
    function openWordList() {
      renderWordList();
      wordListModal.classList.remove('hidden');
    }
    
    // 关闭单词列表
    function closeWordList() {
      wordListModal.classList.add('hidden');
    }
    
    // 渲染列表
    function renderLists() {
      listsContainer.innerHTML = '';
      
      Object.keys(vocabularyData.lists).forEach(listName => {
        const listItem = document.createElement('div');
        listItem.className = `p-3 border rounded-lg mb-2 cursor-pointer transition-all ${
          listName === vocabularyData.currentList ? 'list-item-active' : 'hover:bg-gray-50 border-gray-200'
        }`;
        listItem.innerHTML = `
          <div class="flex justify-between items-center">
            <span>${listName}</span>
            <span class="text-xs text-gray-500">${vocabularyData.lists[listName].length}个单词</span>
          </div>
        `;
        
        listItem.addEventListener('click', () => {
          vocabularyData.currentList = listName;
          vocabularyList = vocabularyData.lists[listName];
          currentIndex = 0;
          localStorage.setItem('currentWordIndex', currentIndex);
          saveVocabularyData();
          resetPlayTimesState();
          displayCurrentWord();
          renderLists();
          currentListNameEl.textContent = listName;
        });
        
        listsContainer.appendChild(listItem);
      });
    }
    
    // 创建新列表
    function createNewList() {
      const listName = newListNameInput.value.trim();
      if (!listName) {
        alert('请输入列表名称');
        return;
      }
      
      if (vocabularyData.lists[listName]) {
        alert('该列表名称已存在');
        return;
      }
      
      vocabularyData.lists[listName] = [];
      vocabularyData.currentList = listName;
      vocabularyList = [];
      currentIndex = 0;
      localStorage.setItem('currentWordIndex', currentIndex);
      
      saveVocabularyData();
      newListNameInput.value = '';
      resetPlayTimesState();
      renderLists();
      currentListNameEl.textContent = listName;
      displayCurrentWord();
    }
    
    // 删除列表
    function deleteSelectedList() {
      const currentList = vocabularyData.currentList;
      
      if (currentList === "默认列表") {
        alert('默认列表不能删除');
        return;
      }
      
      if (!confirm(`确定要删除列表"${currentList}"吗？所有单词将丢失`)) return;
      
      delete vocabularyData.lists[currentList];
      vocabularyData.currentList = "默认列表";
      vocabularyList = vocabularyData.lists["默认列表"];
      currentIndex = 0;
      localStorage.setItem('currentWordIndex', currentIndex);
      
      saveVocabularyData();
      resetPlayTimesState();
      renderLists();
      currentListNameEl.textContent = "默认列表";
      displayCurrentWord();
    }
    
    // 打开列表管理
    function openListManager() {
      renderLists();
      listManagerModal.classList.remove('hidden');
      newListNameInput.focus();
    }
    
    // 关闭列表管理
    function closeListManager() {
      listManagerModal.classList.add('hidden');
    }
    
    // 打开播放次数设置
    function openPlayTimesModal(isSettingDefault = false) {
      if (vocabularyList.length === 0 && !isSettingDefault) return;
      
      playTimesModalTitle.textContent = isSettingDefault ? "设置默认播放次数" : "设置播放次数";
      playTimesModal.classList.remove('hidden');
      
      document.querySelectorAll('.play-time-btn').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('border-gray-200', 'hover:bg-primary/10');
        if (parseInt(btn.dataset.times) === vocabularyData.defaultPlayTimes) {
          btn.classList.add('bg-primary', 'text-white');
          btn.classList.remove('border-gray-200', 'hover:bg-primary/10');
        }
      });
      
      customTimesInput.value = isSettingDefault ? vocabularyData.defaultPlayTimes : '';
      playTimesModal.dataset.settingDefault = isSettingDefault ? 'true' : 'false';
    }
    
    // 关闭播放次数设置
    function closePlayTimesModal() {
      playTimesModal.classList.add('hidden');
    }
    
    // 绑定播放次数按钮
    function bindPlayTimeBtns() {
      document.querySelectorAll('.play-time-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const times = parseInt(btn.dataset.times);
          const isSettingDefault = playTimesModal.dataset.settingDefault === 'true';
          playWordByTimes(times, isSettingDefault);
        });
      });
      
      confirmCustomTimesBtn.addEventListener('click', () => {
        const customTimes = parseInt(customTimesInput.value.trim());
        if (isNaN(customTimes) || customTimes < 1 || customTimes > 100) {
          alert('请输入1-100之间的有效数字');
          return;
        }
        
        const isSettingDefault = playTimesModal.dataset.settingDefault === 'true';
        playWordByTimes(customTimes, isSettingDefault);
      });
      
      customTimesInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') confirmCustomTimesBtn.click();
      });
    }
    
    // 事件监听
    playBtn.addEventListener('click', () => {
      activateAudioContext(); // 激活音频上下文
      if (vocabularyList.length === 0) return;
      resetPlayTimesState();
      speakWord(vocabularyList[currentIndex].english);
    });
    
    playDefaultBtn.addEventListener('click', () => {
      activateAudioContext(); // 激活音频上下文
      if (vocabularyList.length === 0) return;
      playWordByTimes(vocabularyData.defaultPlayTimes);
    });
    
    pauseBtn.addEventListener('click', togglePause);
    prevBtn.addEventListener('click', prevWord);
    nextBtn.addEventListener('click', nextWord);
    importBtn.addEventListener('click', openImportModal);
    cancelImport.addEventListener('click', closeImportModal);
    confirmImport.addEventListener('click', confirmWordImport);
    resetBtn.addEventListener('click', clearCurrentList);
    listManagerBtn.addEventListener('click', openListManager);
    closeListManagerBtn.addEventListener('click', closeListManager);
    createListBtn.addEventListener('click', createNewList);
    deleteListBtn.addEventListener('click', deleteSelectedList);
    changeDefaultTimesBtn.addEventListener('click', () => openPlayTimesModal(true));
    cancelPlayTimesBtn.addEventListener('click', closePlayTimesModal);
    stopPlayBtn.addEventListener('click', stopPlayByTimes);
    wordListBtn.addEventListener('click', openWordList);
    showWordListBtn.addEventListener('click', openWordList);
    closeWordListBtn.addEventListener('click', closeWordList);
    cancelWordListBtn.addEventListener('click', closeWordList);
    shuffleWordsBtn.addEventListener('click', shuffleWords);
    
    // 新建列表按Enter
    newListNameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') createNewList();
    });
    
    // 点击弹窗外部关闭
    importModal.addEventListener('click', (e) => { if (e.target === importModal) closeImportModal(); });
    listManagerModal.addEventListener('click', (e) => { if (e.target === listManagerModal) closeListManager(); });
    playTimesModal.addEventListener('click', (e) => { if (e.target === playTimesModal) closePlayTimesModal(); });
    wordListModal.addEventListener('click', (e) => { if (e.target === wordListModal) closeWordList(); });
    
    // 键盘快捷键
    document.addEventListener('keydown', (e) => {
      // 检查是否在单词列表模态框中
      if (!wordListModal.classList.contains('hidden')) {
        if (e.key === 'Escape') {
          closeWordList();
          return;
        }
        
        // 在单词列表中导航
        if (vocabularyList.length > 0) {
          if (e.key === 'ArrowUp') { // 上箭头
            e.preventDefault();
            const newIndex = Math.max(0, currentIndex - 1);
            if (newIndex !== currentIndex) {
              goToWord(newIndex);
            }
          } else if (e.key === 'ArrowDown') { // 下箭头
            e.preventDefault();
            const newIndex = Math.min(vocabularyList.length - 1, currentIndex + 1);
            if (newIndex !== currentIndex) {
              goToWord(newIndex);
            }
          } else if (e.key === 'Enter' || e.key === ' ') { // 回车或空格播放当前单词
            e.preventDefault();
            speakWord(vocabularyList[currentIndex].english);
          } else if (e.key === 'o' || e.key === 'O') { // O键跳转到当前选中单词并关闭列表
            e.preventDefault();
            closeWordList();
          } else if (e.key === 'r' || e.key === 'R') { // R键随机排序
            e.preventDefault();
            shuffleWords();
          }
        }
        return;
      }
      
      if (!importModal.classList.contains('hidden') || 
          !listManagerModal.classList.contains('hidden') ||
          !playTimesModal.classList.contains('hidden')) {
        if (e.key === 'Escape') {
          closeImportModal();
          closeListManager();
          closePlayTimesModal();
        }
        return;
      }
      
      if (vocabularyList.length === 0) return;
      
      if (e.key === ' ') { // 空格播放
        e.preventDefault();
        activateAudioContext(); // 激活音频上下文
        resetPlayTimesState();
        speakWord(vocabularyList[currentIndex].english);
      } else if (e.key === 'ArrowLeft') { // 左箭头上一个
        e.preventDefault();
        prevWord();
      } else if (e.key === 'ArrowRight') { // 右箭头下一个
        e.preventDefault();
        nextWord();
      } else if (e.key === 'l' || e.key === 'L') { // L默认次数播放
        e.preventDefault();
        activateAudioContext(); // 激活音频上下文
        playWordByTimes(vocabularyData.defaultPlayTimes);
      } else if (e.key === 'd' || e.key === 'D') { // D修改默认次数
        e.preventDefault();
        openPlayTimesModal(true);
      } else if (e.key === 'i' || e.key === 'I') { // I导入
        e.preventDefault();
        openImportModal();
      } else if (e.key === 'm' || e.key === 'M') { // M列表管理
        e.preventDefault();
        openListManager();
      } else if (e.key === 'w' || e.key === 'W') { // W单词列表
        e.preventDefault();
        openWordList();
      } else if (e.key === 's' || e.key === 'S') { // S停止
        e.preventDefault();
        if (isPlayingByTimes) stopPlayByTimes();
      } else if (e.key === 'p' || e.key === 'P') { // P暂停/继续
        e.preventDefault();
        if (isPlayingByTimes) togglePause();
      } else if (e.key === 'r' || e.key === 'R') { // R随机排序
        e.preventDefault();
        shuffleWords();
      }
    });
    
    // 初始化
    currentListNameEl.textContent = vocabularyData.currentList;
    defaultTimesDisplay.textContent = `${vocabularyData.defaultPlayTimes}次`;
    displayCurrentWord();
    bindPlayTimeBtns();
  </script>
  
  <!-- 注册Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(registration => {
            console.log('ServiceWorker注册成功:', registration.scope);
            // 发送保活消息
            if (registration.active) {
              registration.active.postMessage('keepAlive');
            }
          })
          .catch(err => console.log('ServiceWorker注册失败:', err));
      });
    }
  </script>
</body>
</html>
